name: Deploy Go + templ site to gh-pages
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Configure GOBIN and PATH
        run: |
          echo "GOBIN=${{ github.workspace }}/go/bin" >> $GITHUB_ENV
          echo "${{ github.workspace }}/go/bin" >> $GITHUB_PATH

      - name: Install templ (go install)
        run: |
          go install github.com/a-h/templ/cmd/templ@latest

      - name: Verify templ
        run: templ --version

      - name: Run templ generate
        run: templ generate

      - name: Build generator binary
        run: go build -o ./tmp/main .

      - name: (Optional) Run built generator if it further generates site
        run: ./tmp/main generate || true

      - name: Verify public exists
        run: |
          if [ ! -d public ]; then
            echo "public/ not found" >&2
            ls -la
            exit 1
          fi

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: false